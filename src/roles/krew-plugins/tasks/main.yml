---

# - name: debug
#   debug:
#     msg: "{{ item }}"
#   with_items: 
#     - "{{ list_plugins }}"

- name: "Check plugin {{ item }}"
  become: false
  environment:
    PATH: "{{ ansible_env.PATH }}:{{ lookup('env','HOME') + '/.krew/bin/' }}"
  shell: "kubectl krew list | grep -o {{ item }}"
  args:
    warn: no
  register: list_plugin_installed
  changed_when: false
  failed_when: false
  with_items: 
    - "{{ list_plugins }}"

# - name: debug
#   debug:
#     msg: "{{ list_plugin_installed }}"


# - name: debug2
#   debug:
#     msg: "{{ item }}"
#   with_items: 
#     - "{{ list_plugin_installed.results }}"

- name: Install plugin
  become: false
  environment:
    PATH: "{{ ansible_env.PATH }}:{{ lookup('env','HOME') + '/.krew/bin/' }}"
  shell: "kubectl krew install {{ item.item }}"
  when: item.rc == 1
  with_items: 
    - "{{ list_plugin_installed.results }}"

