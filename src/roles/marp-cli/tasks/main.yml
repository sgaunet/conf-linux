---

- name: Check marp version
  become: false
  shell: 'marp -v'
  register: marp_version_client_installed
  changed_when: false
  failed_when: false
  check_mode: no

# - name: MarpVersion
#   debug:
#     msg: "{{marp_version_client_installed.stdout | regex_search('@marp-team/marp-cli v(.+) .w/ @marp-team/marp-core.*$','\\1') }}"

- name: MarpVersion
  set_fact:
    marp_version_installed: ""
  check_mode: no
  when: marp_version_client_installed.stdout == ''

- name: MarpVersion
  set_fact:
    marp_version_installed: "{{marp_version_client_installed.stdout | regex_search('@marp-team/marp-cli v(.+) .w/ @marp-team/marp-core.*$','\\1') | join('') }}"
  check_mode: no
  when: marp_version_client_installed.stdout != ''

- name: Check marp version
  shell: '/bin/true'
  changed_when: marp_version_installed != marp_version
  check_mode: no

# - debug:
#     msg: "{{marp_version_installed}} != {{marp_version}}"

- name: marp
  unarchive:
    src: "https://github.com/marp-team/marp-cli/releases/download/v{{ marp_version }}/marp-cli-v{{ marp_version }}-{{ marp_os }}.tar.gz"
    dest: /usr/local/bin
    # extra_opts:
    # - --strip=1
    # - --wildcards
    # - '*/marp'
    remote_src: True
  when: 
    - not ansible_check_mode
    - marp_version_installed != marp_version