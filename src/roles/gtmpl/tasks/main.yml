---

- name: Check gtmpl version
  shell: 'gtmpl -v'
  register: gtmpl_version_client_installed
  changed_when: false
  failed_when: false

- name: Create a directory if it does not exist
  file:
    path: "{{ gtmpl_tmp_directory }}/{{ gtmpl_os }}-{{ gtmpl_arch }}/"
    state: directory
    mode: '0755'
  when: gtmpl_version != gtmpl_version_client_installed.stdout


- name: Download and unarchive gtmpl
  unarchive:
    src: "https://github.com/sgaunet/gtmpl/releases/download/{{ gtmpl_version }}/gtmpl_{{ gtmpl_os }}_{{ gtmpl_arch }}.tar.gz"
    dest: "{{ gtmpl_tmp_directory }}/{{ gtmpl_os }}-{{ gtmpl_arch }}/"
    remote_src: true
    mode: 0755
  when: gtmpl_version != gtmpl_version_client_installed.stdout


- name: Copy file with owner and permissions
  copy:
    src: "{{ gtmpl_tmp_directory }}/{{ gtmpl_os }}-{{ gtmpl_arch }}/gtmpl"
    dest: "{{ gtmpl_bin_path }}/gtmpl"
    mode: '0755'
    remote_src: yes
  when: gtmpl_version != gtmpl_version_client_installed.stdout

- name: Clean temporary directory
  file:
    state: absent
    path: "{{ gtmpl_tmp_directory }}/{{ gtmpl_os }}-{{ gtmpl_arch }}"
  when: gtmpl_version != gtmpl_version_client_installed.stdout

- name: Setup my gtmpl-cfg repository 
  git:
    repo: git@github.com:sgaunet/gtmpl-cfg.git
    dest: "{{ lookup('env','HOME') }}/.gtmpl"
    update: yes
  become: false